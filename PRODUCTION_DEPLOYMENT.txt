====================================================================
    PRODUCTION SERVER - QUICK DEPLOYMENT CHECKLIST
====================================================================

Server: payrollsoft.in/emailvalidation
Database: email_id
PHP: /opt/plesk/php/8.1/bin/php

--------------------------------------------------------------------
STEP 1: DEPLOY CODE
--------------------------------------------------------------------

ssh user@payrollsoft.in
cd /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation
git pull origin master
cd frontend && npm install && npm run build && cd ..

--------------------------------------------------------------------
STEP 2: INSTALL CRON JOB (CRITICAL - DO THIS NOW)
--------------------------------------------------------------------

crontab -e

# Add this line:
*/2 * * * * /opt/plesk/php/8.1/bin/php /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/campaign_cron.php >> /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/logs/cron_output.log 2>&1

# Save and exit (:wq)

# Verify cron is installed:
crontab -l

--------------------------------------------------------------------
STEP 3: TEST CRON JOB
--------------------------------------------------------------------

# Run manually first:
/opt/plesk/php/8.1/bin/php /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/campaign_cron.php

# Expected output:
# "Database config loaded for: PRODUCTION - DB: email_id (CLI: YES)"
# "Task successfully completed in 0 seconds"

--------------------------------------------------------------------
STEP 4: TEST CAMPAIGN START IN BROWSER
--------------------------------------------------------------------

1. Login: https://payrollsoft.in/emailvalidation
2. Go to Master (Campaigns) page
3. Click "Start" button on a campaign
4. Expected: "Campaign #X started successfully!"
5. Wait 2 minutes for cron to pick it up
6. Refresh page - should see progress counter increasing

--------------------------------------------------------------------
STEP 5: MONITOR (Optional)
--------------------------------------------------------------------

# Watch cron output:
tail -f /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/logs/cron_output.log

# Watch campaign progress:
tail -f /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/logs/orchestrator_*.log

# Check database:
mysql -u email_id -p email_id -e "SELECT campaign_id, status, sent_emails, total_emails FROM campaign_status ORDER BY campaign_id DESC LIMIT 5;"

--------------------------------------------------------------------
TROUBLESHOOTING
--------------------------------------------------------------------

Problem: Campaign stuck in "running" but no emails sent

Solution 1: Check cron is running
  crontab -l  # Should show the cron job line

Solution 2: Check user has SMTP accounts
  mysql -u email_id -p email_id -e "SELECT COUNT(*) FROM smtp_accounts WHERE user_id = 1 AND is_active = 1;"
  # Should return > 0

Solution 3: Manually run cron to see errors
  /opt/plesk/php/8.1/bin/php /var/www/vhosts/payrollsoft.in/httpdocs/emailvalidation/backend/campaign_cron.php

Solution 4: Reset stuck campaign
  mysql -u email_id -p email_id -e "UPDATE campaign_status SET status = 'pending', process_pid = NULL WHERE campaign_id = X;"

--------------------------------------------------------------------
IMPORTANT NOTES
--------------------------------------------------------------------

✓ Cron runs every 2 minutes - campaigns start within 2 min of clicking "Start"
✓ Each user's campaigns use ONLY their SMTP accounts (user_id filtering)
✓ All sent emails tracked in mail_blaster with smtp_account_id, smtp_email, user_id
✓ Campaigns auto-complete when all emails sent
✓ Frontend displays real-time progress (sent/total counts)

====================================================================
                    DEPLOYMENT COMPLETE!
====================================================================

For detailed troubleshooting, see: CAMPAIGN_START_SETUP.md
