<!DOCTYPE html>
<html>
<head>
    <title>Test Attachment Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Campaign Attachment Upload</h1>
    
    <div class="section">
        <h2>1. Upload Campaign with Attachment</h2>
        <form id="testForm">
            <div>
                <label>Description:</label><br>
                <input type="text" id="description" value="Test Campaign with Attachment" style="width: 100%; padding: 5px;">
            </div>
            <div style="margin-top: 10px;">
                <label>Subject:</label><br>
                <input type="text" id="subject" value="Test Email with Attachment" style="width: 100%; padding: 5px;">
            </div>
            <div style="margin-top: 10px;">
                <label>Body:</label><br>
                <textarea id="body" style="width: 100%; padding: 5px; height: 100px;">This is a test email with an attachment.</textarea>
            </div>
            <div style="margin-top: 10px;">
                <label>Attachment:</label><br>
                <input type="file" id="attachment" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt">
            </div>
            <button type="submit" style="margin-top: 10px;">Upload Campaign</button>
        </form>
        <div id="uploadResult" class="result" style="display: none;"></div>
    </div>

    <div class="section">
        <h2>2. List Campaigns with Attachments</h2>
        <button onclick="listCampaigns()">List All Campaigns</button>
        <div id="listResult" class="result" style="display: none;"></div>
    </div>

    <div class="section">
        <h2>3. Check Attachment Files</h2>
        <button onclick="checkFiles()">Check Storage Directory</button>
        <div id="filesResult" class="result" style="display: none;"></div>
    </div>

    <script>
        const API_URL = 'http://localhost/verify_emails/MailPilot_CRM/backend/routes/api.php/api/master/campaigns';

        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('description', document.getElementById('description').value);
            formData.append('mail_subject', document.getElementById('subject').value);
            formData.append('mail_body', document.getElementById('body').value);
            formData.append('send_as_html', '1');
            
            const fileInput = document.getElementById('attachment');
            if (fileInput.files[0]) {
                formData.append('attachment', fileInput.files[0]);
            }
            
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Uploading...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                resultDiv.innerHTML = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                resultDiv.className = 'result ' + (result.success ? 'success' : 'error');
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        });

        async function listCampaigns() {
            const resultDiv = document.getElementById('listResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Loading...';
            
            try {
                const response = await fetch(API_URL);
                const campaigns = await response.json();
                
                const withAttachments = campaigns.filter(c => c.attachment_path);
                
                let html = '<h3>Campaigns with Attachments (' + withAttachments.length + '):</h3>';
                if (withAttachments.length > 0) {
                    html += '<ul>';
                    withAttachments.forEach(c => {
                        html += '<li><strong>ID ' + c.campaign_id + ':</strong> ' + c.description + 
                               '<br><small>Attachment: ' + c.attachment_path + '</small></li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p>No campaigns with attachments found.</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">Error: ' + error.message + '</span>';
            }
        }

        async function checkFiles() {
            const resultDiv = document.getElementById('filesResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Note: This requires a separate PHP script to list files. Check the backend/storage/attachments/ directory manually.</p>';
        }
    </script>
</body>
</html>
